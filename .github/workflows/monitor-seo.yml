name: Monitor SEO Files (robots.txt & sitemap.xml)

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

env:
  SITE_URL: 'https://www.leanature.com/'
  SMTP_SERVER: 'smtp.gmail.com'
  SMTP_PORT: '587'
  EMAIL_USERNAME: 'vbouvier.redactrice@gmail.com'
  EMAIL_PASSWORD: 'avrf enpz otim qlnf'
  NOTIFICATION_EMAIL: 'vbouvier@cybercite.fr'
  EMAIL_FROM: 'SEO Monitor <vbouvier.redactrice@gmail.com>'

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create storage directory
      run: mkdir -p monitoring-data

    - name: Check robots.txt
      id: check_robots
      run: |
        echo "ü§ñ V√©rification de robots.txt..."
        ROBOTS_URL="${SITE_URL}robots.txt"
        
        # CORRECTION ICI : un seul $ au lieu de $$
        HTTP_STATUS=$(curl -s -o monitoring-data/robots_new.txt -w "%{http_code}" -L "$ROBOTS_URL")
        
        echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
        echo "HTTP Status: $HTTP_STATUS"
        
        if [ "$HTTP_STATUS" -ne 200 ]; then
          echo "error=true" >> $GITHUB_OUTPUT
          echo "message=Erreur HTTP $HTTP_STATUS lors de l'acc√®s √† robots.txt" >> $GITHUB_OUTPUT
        else
          echo "error=false" >> $GITHUB_OUTPUT
          
          if [ -f monitoring-data/robots_previous.txt ]; then
            if ! diff -u monitoring-data/robots_previous.txt monitoring-data/robots_new.txt > monitoring-data/robots_diff.txt; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "üìù Changements d√©tect√©s dans robots.txt"
              
              ADDED_RULES=$(grep "^+" monitoring-data/robots_diff.txt | grep -E "Allow:|Disallow:" | grep -v "^+++" || true)
              REMOVED_RULES=$(grep "^-" monitoring-data/robots_diff.txt | grep -E "Allow:|Disallow:" | grep -v "^---" || true)
              
              if [ -n "$ADDED_RULES" ]; then
                echo "added_rules<<EOF" >> $GITHUB_OUTPUT
                echo "$ADDED_RULES" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
              fi
              
              if [ -n "$REMOVED_RULES" ]; then
                echo "removed_rules<<EOF" >> $GITHUB_OUTPUT
                echo "$REMOVED_RULES" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
              fi
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Aucun changement dans robots.txt"
            fi
          else
            echo "changed=new" >> $GITHUB_OUTPUT
            echo "üÜï Premi√®re v√©rification de robots.txt"
          fi
        fi

    - name: Check sitemap.xml
      id: check_sitemap
      run: |
        echo "üó∫Ô∏è V√©rification de sitemap.xml..."
        SITEMAP_URL="${SITE_URL}media/google_sitemap_3.xml"
        
        # CORRECTION ICI : un seul $
        HTTP_STATUS=$(curl -s -o monitoring-data/sitemap_new.xml -w "%{http_code}" -L "$SITEMAP_URL")
        
        echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
        echo "HTTP Status: $HTTP_STATUS"
        
        if [ "$HTTP_STATUS" -ne 200 ]; then
          echo "error=true" >> $GITHUB_OUTPUT
          echo "message=Erreur HTTP $HTTP_STATUS lors de l'acc√®s √† sitemap.xml" >> $GITHUB_OUTPUT
        else
          echo "error=false" >> $GITHUB_OUTPUT
          
          if [ -f monitoring-data/sitemap_previous.xml ]; then
            if ! diff -u monitoring-data/sitemap_previous.xml monitoring-data/sitemap_new.xml > monitoring-data/sitemap_diff.txt; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "üìù Changements d√©tect√©s dans sitemap.xml"
              
              ADDED_URLS=$(grep "^+.*<loc>" monitoring-data/sitemap_diff.txt | wc -l || echo 0)
              REMOVED_URLS=$(grep "^-.*<loc>" monitoring-data/sitemap_diff.txt | wc -l || echo 0)
              
              echo "added_urls=$ADDED_URLS" >> $GITHUB_OUTPUT
              echo "removed_urls=$REMOVED_URLS" >> $GITHUB_OUTPUT
              
              if [ $ADDED_URLS -gt 0 ]; then
                echo "sample_added<<EOF" >> $GITHUB_OUTPUT
                g
