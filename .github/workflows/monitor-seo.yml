name: Monitor SEO Files - Robots.txt & Sitemap.xml

on:
  schedule:
    # Ex√©cution toutes les 12 heures (√† 8h et 20h UTC)
    - cron: '0 8,20 * * *'
  workflow_dispatch:  # Permet le d√©clenchement manuel

env:
  SITE_URL: 'https://www.leanature.com/'
  EMAIL_USERNAME: 'vbouvier.redactrice@gmail.com'
  EMAIL_PASSWORD: 'avrf enpz otim qlnf'
  NOTIFICATION_EMAIL: 'vbouvier@cybercite.fr'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Setup directories
      run: |
        mkdir -p monitoring-data
        mkdir -p monitoring-history
        echo "‚úÖ Directories cr√©√©s"
    
    - name: Download current robots.txt
      id: download_robots
      run: |
        echo "üì• T√©l√©chargement de robots.txt..."
        ROBOTS_URL="${SITE_URL}robots.txt"
        
        HTTP_STATUS=$(curl -s -o monitoring-data/robots_current.txt -w "%{http_code}" "$ROBOTS_URL")
        echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
        
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "‚úÖ robots.txt t√©l√©charg√© (HTTP $HTTP_STATUS)"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "Lignes: $(wc -l < monitoring-data/robots_current.txt)"
        else
          echo "‚ùå Erreur HTTP $HTTP_STATUS"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "error_message=Erreur HTTP $HTTP_STATUS pour robots.txt" >> $GITHUB_OUTPUT
        fi
    
    - name: Download current sitemap.xml
      id: download_sitemap
      run: |
        echo "üì• T√©l√©chargement de sitemap.xml..."
        SITEMAP_URL="${SITE_URL}media/google_sitemap_3.xml"
        
        HTTP_STATUS=$(curl -s -o monitoring-data/sitemap_current.xml -w "%{http_code}" "$SITEMAP_URL")
        echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
        
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "‚úÖ sitemap.xml t√©l√©charg√© (HTTP $HTTP_STATUS)"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "Taille: $(wc -c < monitoring-data/sitemap_current.xml) bytes"
        else
          echo "‚ùå Erreur HTTP $HTTP_STATUS"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "error_message=Erreur HTTP $HTTP_STATUS pour sitemap.xml" >> $GITHUB_OUTPUT
        fi
    
    - name: Restore previous files from artifacts
      id: restore_previous
      uses: actions/download-artifact@v4
      with:
        name: monitoring-history
        path: monitoring-history/
      continue-on-error: true  # Important : ne pas √©chouer si l'artifact n'existe pas
    
    - name: Check for changes in robots.txt
      id: check_robots_changes
      if: steps.download_robots.outputs.success == 'true'
      run: |
        echo "üîç V√©rification des changements dans robots.txt..."
        
        if [ -f monitoring-history/robots_previous.txt ]; then
          if ! diff -q monitoring-history/robots_previous.txt monitoring-data/robots_current.txt > /dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Changements d√©tect√©s dans robots.txt!"
            
            # Cr√©er un diff d√©taill√©
            diff -u monitoring-history/robots_previous.txt monitoring-data/robots_current.txt > monitoring-data/robots_diff.txt || true
            
            # Analyser les changements
            ADDED_LINES=$(grep "^+" monitoring-data/robots_diff.txt | grep -v "^+++" | wc -l || echo 0)
            REMOVED_LINES=$(grep "^-" monitoring-data/robots_diff.txt | grep -v "^---" | wc -l || echo 0)
            
            echo "added_lines=$ADDED_LINES" >> $GITHUB_OUTPUT
            echo "removed_lines=$REMOVED_LINES" >> $GITHUB_OUTPUT
            
            # Extraire des exemples de changements
            echo "sample_changes<<EOF" >> $GITHUB_OUTPUT
            grep "^[+-]" monitoring-data/robots_diff.txt | grep -v "^[+-][+-][+-]" | head -10 >> $GITHUB_OUTPUT || true
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Aucun changement dans robots.txt"
          fi
        else
          echo "changed=new" >> $GITHUB_OUTPUT
          echo "üÜï Premi√®re v√©rification de robots.txt"
        fi
    
    - name: Check for changes in sitemap.xml
      id: check_sitemap_changes
      if: steps.download_sitemap.outputs.success == 'true'
      run: |
        echo "üîç V√©rification des changements dans sitemap.xml..."
        
        if [ -f monitoring-history/sitemap_previous.xml ]; then
          if ! diff -q monitoring-history/sitemap_previous.xml monitoring-data/sitemap_current.xml > /dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Changements d√©tect√©s dans sitemap.xml!"
            
            # Cr√©er un diff d√©taill√©
            diff -u monitoring-history/sitemap_previous.xml monitoring-data/sitemap_current.xml > monitoring-data/sitemap_diff.txt || true
            
            # Compter les URLs ajout√©es/supprim√©es
            ADDED_URLS=$(grep "^+.*<loc>" monitoring-data/sitemap_diff.txt | wc -l || echo 0)
            REMOVED_URLS=$(grep "^-.*<loc>" monitoring-data/sitemap_diff.txt | wc -l || echo 0)
            MODIFIED_DATES=$(grep "^[+-].*<lastmod>" monitoring-data/sitemap_diff.txt | wc -l || echo 0)
            
            echo "added_urls=$ADDED_URLS" >> $GITHUB_OUTPUT
            echo "removed_urls=$REMOVED_URLS" >> $GITHUB_OUTPUT
            echo "modified_dates=$MODIFIED_DATES" >> $GITHUB_OUTPUT
            
            # Extraire des exemples d'URLs
            echo "sample_urls<<EOF" >> $GITHUB_OUTPUT
            grep "^[+-].*<loc>" monitoring-data/sitemap_diff.txt | head -5 | sed 's/<[^>]*>//g' | sed 's/^[+-]//' >> $GITHUB_OUTPUT || true
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Aucun changement dans sitemap.xml"
          fi
        else
          echo "changed=new" >> $GITHUB_OUTPUT
          echo "üÜï Premi√®re v√©rification de sitemap.xml"
        fi
    
    - name: Debug - Check if email should be sent
      run: |
        echo "=== CONDITIONS POUR L'EMAIL ==="
        echo "robots.txt success: ${{ steps.download_robots.outputs.success }}"
        echo "sitemap.xml success: ${{ steps.download_sitemap.outputs.success }}"
        echo "robots.txt changed: ${{ steps.check_robots_changes.outputs.changed }}"
        echo "sitemap.xml changed: ${{ steps.check_sitemap_changes.outputs.changed }}"
        
        # Pour le premier run, on envoie toujours un email de confirmation
        if [ "${{ steps.check_robots_changes.outputs.changed }}" == "new" ] || [ "${{ steps.check_sitemap_changes.outputs.changed }}" == "new" ]; then
          echo "üÜï PREMIER RUN - Email de confirmation sera envoy√©"
        fi
    
    - name: Send notification email
      # MODIFI√â : Envoie aussi lors du premier run
      if: |
        steps.download_robots.outputs.success == 'false' ||
        steps.download_sitemap.outputs.success == 'false' ||
        steps.check_robots_changes.outputs.changed == 'true' ||
        steps.check_sitemap_changes.outputs.changed == 'true' ||
        steps.check_robots_changes.outputs.changed == 'new' ||
        steps.check_sitemap_changes.outputs.changed == 'new'
      run: |
        echo "üìß Pr√©paration de l'email..."
        python3 << 'EOF'
        import smtplib
        import ssl
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from datetime import datetime
        import os
        
        # Configuration
        smtp_server = "smtp.gmail.com"
        port = 587
        sender = "${{ env.EMAIL_USERNAME }}"
        password = "${{ env.EMAIL_PASSWORD }}"
        receiver = "${{ env.NOTIFICATION_EMAIL }}"
        
        print(f"Configuration email:")
        print(f"  From: {sender}")
        print(f"  To: {receiver}")
        print(f"  Server: {smtp_server}:{port}")
        
        # D√©terminer le type d'alerte
        is_first_run = "${{ steps.check_robots_changes.outputs.changed }}" == "new" or "${{ steps.check_sitemap_changes.outputs.changed }}" == "new"
        has_error = "${{ steps.download_robots.outputs.success }}" == "false" or "${{ steps.download_sitemap.outputs.success }}" == "false"
        has_changes = "${{ steps.check_robots_changes.outputs.changed }}" == "true" or "${{ steps.check_sitemap_changes.outputs.changed }}" == "true"
        
        if is_first_run:
            subject = "üöÄ Monitoring SEO activ√© - √âtat initial enregistr√©"
        elif has_error:
            subject = "üö® [URGENT] Monitoring SEO - Erreurs d√©tect√©es"
        else:
            subject = "üìù Monitoring SEO - Changements d√©tect√©s"
        
        # Construire le message HTML simplifi√©
        html_content = f"""
        <html>
        <head>
            <style>
                body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
                h1 {{ color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }}
                h2 {{ color: #34495e; margin-top: 25px; }}
                .success {{ background: #d4edda; border-left: 4px solid #28a745; padding: 10px; margin: 10px 0; }}
                .info {{ background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 10px; margin: 10px 0; }}
                .warning {{ background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0; }}
                .error {{ background: #f8d7da; border-left: 4px solid #dc3545; padding: 10px; margin: 10px 0; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìä Rapport de Monitoring SEO</h1>
                <p><strong>Site surveill√© :</strong> ${{ env.SITE_URL }}</p>
                <p><strong>Date :</strong> {datetime.now().strftime("%d/%m/%Y √† %H:%M")}</p>
                
                <h2>ü§ñ robots.txt</h2>
        """
        
        # Section robots.txt
        robots_changed = "${{ steps.check_robots_changes.outputs.changed }}"
        if "${{ steps.download_robots.outputs.success }}" == "false":
            html_content += '<div class="error">‚ùå <strong>ERREUR :</strong> Impossible d\'acc√©der au fichier</div>'
        elif robots_changed == "new":
            html_content += '<div class="info">üÜï <strong>Premi√®re v√©rification</strong> - √âtat initial enregistr√©</div>'
        elif robots_changed == "true":
            html_content += '<div class="warning">üìù <strong>Modifications d√©tect√©es</strong></div>'
        else:
            html_content += '<div class="success">‚úÖ <strong>Aucun changement</strong></div>'
        
        # Section sitemap.xml
        html_content += "<h2>üó∫Ô∏è sitemap.xml</h2>"
        
        sitemap_changed = "${{ steps.check_sitemap_changes.outputs.changed }}"
        if "${{ steps.download_sitemap.outputs.success }}" == "false":
            html_content += '<div class="error">‚ùå <strong>ERREUR :</strong> Impossible d\'acc√©der au fichier</div>'
        elif sitemap_changed == "new":
            html_content += '<div class="info">üÜï <strong>Premi√®re v√©rification</strong> - √âtat initial enregistr√©</div>'
        elif sitemap_changed == "true":
            html_content += '<div class="warning">üìù <strong>Modifications d√©tect√©es</strong></div>'
        else:
            html_content += '<div class="success">‚úÖ <strong>Aucun changement</strong></div>'
        
        # Footer
        html_content += f"""
                <hr style="margin-top: 30px;">
                <p style="font-size: 0.9em; color: #666;">
                    ‚è∞ Prochaine v√©rification dans 12 heures<br>
                    üìß Vous recevrez un email uniquement si des changements sont d√©tect√©s<br>
                    üîó <a href="https://github.com/${{{{ github.repository }}}}/actions">Voir l'historique complet</a>
                </p>
            </div>
        </body>
        </html>
        """
        
        # Cr√©er le message
        message = MIMEMultipart("alternative")
        message["Subject"] = subject
        message["From"] = sender
        message["To"] = receiver
        
        # Version texte
        text_content = f"""
        Rapport de Monitoring SEO
        Site: ${{ env.SITE_URL }}
        Date: {datetime.now().strftime("%d/%m/%Y %H:%M")}
        
        robots.txt: {robots_changed}
        sitemap.xml: {sitemap_changed}
        """
        
        part1 = MIMEText(text_content, "plain")
        part2 = MIMEText(html_content, "html")
        
        message.attach(part1)
        message.attach(part2)
        
        # Envoyer l'email
        try:
            print("Connexion au serveur SMTP...")
            context = ssl.create_default_context()
            with smtplib.SMTP(smtp_server, port) as server:
                server.ehlo()
                server.starttls(context=context)
                server.ehlo()
                print("Authentification...")
                server.login(sender, password)
                print("Envoi de l'email...")
                server.sendmail(sender, receiver, message.as_string())
            print(f"‚úÖ Email envoy√© avec succ√®s √† {receiver}")
        except smtplib.SMTPAuthenticationError as e:
            print(f"‚ùå Erreur d'authentification: {e}")
            print("V√©rifiez votre App Password Gmail")
            exit(1)
        except Exception as e:
            print(f"‚ùå Erreur lors de l'envoi: {e}")
            exit(1)
        EOF
    
    - name: Save current files as history
      if: always()
      run: |
        echo "üíæ Sauvegarde des fichiers actuels..."
        
        if [ -f monitoring-data/robots_current.txt ] && [ "${{ steps.download_robots.outputs.success }}" == "true" ]; then
          cp monitoring-data/robots_current.txt monitoring-history/robots_previous.txt
          echo "‚úÖ robots.txt sauvegard√©"
        fi
        
        if [ -f monitoring-data/sitemap_current.xml ] && [ "${{ steps.download_sitemap.outputs.success }}" == "true" ]; then
          cp monitoring-data/sitemap_current.xml monitoring-history/sitemap_previous.xml
          echo "‚úÖ sitemap.xml sauvegard√©"
        fi
    
    - name: Upload history as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-history
        path: monitoring-history/
        retention-days: 30
    
    - name: Create summary
      if: always()
      run: |
        echo "# üìä Rapport de Monitoring SEO" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Site :** ${{ env.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "**Date :** $(date '+%d/%m/%Y %H:%M')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Status" >> $GITHUB_STEP_SUMMARY
        echo "- robots.txt : ${{ steps.check_robots_changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
        echo "- sitemap.xml : ${{ steps.check_sitemap_changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_robots_changes.outputs.changed }}" == "new" ] || [ "${{ steps.check_sitemap_changes.outputs.changed }}" == "new" ]; then
          echo "‚úâÔ∏è **Email de confirmation envoy√©**" >> $GITHUB_STEP_SUMMARY
        fi
