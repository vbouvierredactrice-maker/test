name: Test Monitoring Simple

on:
  workflow_dispatch:

env:
  SITE_URL: 'https://www.leanature.com/'
  EMAIL_USERNAME: 'vbouvier.redactrice@gmail.com'
  EMAIL_PASSWORD: 'avrf enpz otim qlnf'
  NOTIFICATION_EMAIL: 'vbouvier@cybercite.fr'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup
      run: |
        mkdir -p monitoring-data
        echo "âœ… Setup OK"
    
    - name: Test robots.txt
      id: robots
      run: |
        echo "Test robots.txt..."
        curl -s -o monitoring-data/robots.txt "https://www.leanature.com/robots.txt"
        if [ -f monitoring-data/robots.txt ]; then
          echo "âœ… robots.txt tÃ©lÃ©chargÃ©"
          echo "success=true" >> $GITHUB_OUTPUT
          wc -l monitoring-data/robots.txt
        else
          echo "âŒ Erreur robots.txt"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Test sitemap
      id: sitemap
      run: |
        echo "Test sitemap..."
        curl -s -o monitoring-data/sitemap.xml "https://www.leanature.com/media/google_sitemap_3.xml"
        if [ -f monitoring-data/sitemap.xml ]; then
          echo "âœ… sitemap.xml tÃ©lÃ©chargÃ©"
          echo "success=true" >> $GITHUB_OUTPUT
          echo "Taille: $(wc -c < monitoring-data/sitemap.xml) bytes"
        else
          echo "âŒ Erreur sitemap"
          echo "success=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Send email with Python
      if: steps.robots.outputs.success == 'true'
      run: |
        python3 << 'EOF'
        import smtplib
        import ssl
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from datetime import datetime
        
        # Configuration
        smtp_server = "smtp.gmail.com"
        port = 587
        sender = "${{ env.EMAIL_USERNAME }}"
        password = "${{ env.EMAIL_PASSWORD }}"
        receiver = "${{ env.NOTIFICATION_EMAIL }}"
        
        # CrÃ©er le message
        message = MIMEMultipart("alternative")
        message["Subject"] = "âœ… Test Monitoring SEO - Tout fonctionne !"
        message["From"] = sender
        message["To"] = receiver
        
        # Corps du message
        text = """
        Test rÃ©ussi !
        
        âœ… robots.txt accessible
        âœ… sitemap.xml accessible
        
        Le monitoring est prÃªt Ã  fonctionner.
        
        Date: {}
        """.format(datetime.now().strftime("%d/%m/%Y %H:%M"))
        
        html = """
        <html>
          <body>
            <h2>âœ… Test Monitoring SEO RÃ©ussi !</h2>
            <p>Les fichiers sont accessibles :</p>
            <ul>
              <li>âœ… robots.txt : OK</li>
              <li>âœ… sitemap.xml : OK</li>
            </ul>
            <p>Le monitoring est prÃªt Ã  fonctionner.</p>
            <p><i>Date: {}</i></p>
          </body>
        </html>
        """.format(datetime.now().strftime("%d/%m/%Y %H:%M"))
        
        part1 = MIMEText(text, "plain")
        part2 = MIMEText(html, "html")
        
        message.attach(part1)
        message.attach(part2)
        
        # Envoyer l'email
        try:
            # CrÃ©er une connexion sÃ©curisÃ©e
            context = ssl.create_default_context()
            
            with smtplib.SMTP(smtp_server, port) as server:
                server.ehlo()
                server.starttls(context=context)
                server.ehlo()
                server.login(sender, password)
                server.sendmail(sender, receiver, message.as_string())
                
            print("âœ… Email envoyÃ© avec succÃ¨s Ã ", receiver)
            
        except Exception as e:
            print(f"âŒ Erreur lors de l'envoi: {e}")
            exit(1)
        EOF
    
    - name: Summary
      if: always()
      run: |
        echo "# ðŸ“Š Test Monitoring" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- robots.txt: ${{ steps.robots.outputs.success == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- sitemap.xml: ${{ steps.sitemap.outputs.success == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Site: ${{ env.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- Email: ${{ env.NOTIFICATION_EMAIL }}" >> $GITHUB_STEP_SUMMARY
